数据库
--------------------------------------------
- [redisDb结构](#redisdb结构)
- [切换数据库](#切换数据库)
- [数据库键空间](#数据库键空间)
- [设置键的生存时间或过期时间](#设置键的生存时间或过期时间)
  - [设置过期时间](#设置过期时间)
  - [保存过期时间](#保存过期时间)
  - [移除过期时间](#移除过期时间)
  - [计算并返回剩余生存时间](#计算并返回剩余生存时间)
  - [过期键的删除策略](#过期键的删除策略)
  - [AOF,RDB和复制功能对过期键的处理](#aofrdb和复制功能对过期键的处理)
- [数据库通知](#数据库通知)
- [重点回顾](#重点回顾)

# redisDb结构

- Redis服务器将所有数据库都保存在服务器状态RedisServer结构中的db数组中，db数组的每一个项都是一个RedisDb结构，每个RedisDb结构代表一个数据库
- 在初始化服务器时，程序会根据服务器状态的dbnum属性来决定应该创建多少个数据库
- dbnum属性的值由服务器配置的database选项决定，默认为16
- 主要的成员
  - 键空间，dict，保存着数据库中的所有键值对
  - 过期字典，expires，保存着数据库键的过期时间
  - 

# 切换数据库

- 每个Redis客户端都有自己的目标数据库，每当客户端执行数据库写命令或者数据库读命令的时候，目标数据库就会成为这些命令的操作对象
- 默认情况下，Redis客户端的目标数据库为0号数据库，但客户端可以通过执行SELECT命令来切换目标数据库
- 客户端状态RedisClient结构的db属性记录了客户端当前的目标数据库，这个属性是一个指向redisDb结构的指针，指向redisServer.db数组的其中一个元素
- Redis目前没有可以返回客户端目标数据库的命令，所以执行部分命令前，最好先执行一个SELECT命令

# 数据库键空间

- Redis是一个键值对（key-value pair）数据库服务器
- 服务器中的每个数据库都由一个 redis.h/redisDb 结构表示， 其中， redisDb 结构的 dict 字典保存了数据库中的所有键值对， 我们将这个字典称为**键空间（key space）**
- 键空间和用户所见的数据库是直接对应的：
  - 键空间的键也就是数据库的键， 每个键都是一个字符串对象。
  - 键空间的值也就是数据库的值， 每个值可以是字符串对象、列表对象、哈希表对象、集合对象和有序集合对象在内的任意一种 Redis 对象
- 添加一个新键值对到数据库， 实际上就是将一个新键值对添加到键空间字典里面， 其中键为字符串对象， 而值则为任意一种类型的 Redis 对象。
- 删除数据库中的一个键， 实际上就是在键空间里面删除键所对应的键值对对象。
- 对一个数据库键进行更新， 实际上就是对键空间里面键所对应的值对象进行更新， 根据值对象的类型不同， 更新的具体方法也会有所不同。
- 对一个数据库键进行取值， 实际上就是在键空间中取出键所对应的值对象， 根据值对象的类型不同， 具体的取值方法也会有所不同
- 当使用 Redis 命令对数据库进行读写时， 服务器不仅会对键空间执行指定的读写操作， 还会执行一些额外的维护操作， 其中包括：
  - 在读取一个键之后（读操作和写操作都要对键进行读取）， 服务器会根据键是否存在， 以此来更新服务器的键空间命中（hit）次数或键空间不命中（miss）次数， 这两个值可以在 INFO stats 命令的 keyspace_hits 属性和 keyspace_misses 属性中查看。
  - 在读取一个键之后， 服务器会更新键的 LRU （最后一次使用）时间， 这个值可以用于计算键的闲置时间， 使用命令 OBJECT idletime <key> 命令可以查看键 key 的闲置时间。
  - 如果服务器在读取一个键时， 发现该键已经过期， 那么服务器会先删除这个过期键， 然后才执行余下的其他操作， 本章稍后对过期键的讨论会详细说明这一点。
  - 如果有客户端使用 WATCH 命令监视了某个键， 那么服务器在对被监视的键进行修改之后， 会将这个键标记为脏（dirty）， 从而让事务程序注意到这个键已经被修改过， 《事务》一章会详细说明这一点。
  - 服务器每次修改一个键之后， 都会对脏（dirty）键计数器的值增一， 这个计数器会触发服务器的持久化以及复制操作执行， 《RDB 持久化》、《AOF 持久化》和《复制》这三章都会说到这一点。
  - 如果服务器开启了数据库通知功能， 那么在对键进行修改之后， 服务器将按配置发送相应的数据库通知， 本章稍后讨论数据库通知功能的实现时会详细说明这一点。

# 设置键的生存时间或过期时间

- 通过EXPIRE或者PEXPIRE命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间（TTL,Time To Live），在经过指定的秒数或者毫秒数后，服务器会自动删除生存时间为0的键
- 或者通过EXPIREAT或PEXPIREAT以秒或毫秒精度给某个键设置过期时间（绝对时间，UNIX时间戳）
- TTL和PTTL命令接受一个带有生存时间或者过期时间的键，返回这个键的剩余生存时间
  
## 设置过期时间

- `EXPIRE <key> <ttl>`
- `PEXPIRE <key> <ttl>`，单位为毫秒
- `EXPIREAT <key> <timestamp>`， 时间戳
- `PEXPIREAT <key> <timestamp>`
- 前面三个命令最终都是使用第四个命令来实现的

## 保存过期时间

- redisDb结构的expires字典保存了数据库中所有键的过期时间，这个字典被称为**过期字典**
  - 过期字典的键是一个指向键空间中的某个键对象的指针
  - 值是一个long long整数，保存着过期时间，毫秒精度的UNIX时间戳
  
## 移除过期时间

- `PERSIST <key>`
- 在过期字典中查找给定的键，并解除键和值（过期时间）在过期字典中的关联

## 计算并返回剩余生存时间

- `TTL <key>`, `PTTL <key>`
- 通过计算键的过期时间和当前时间之间的差来实现的

## 过期键的删除策略

- 定时删除:
  - 在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作
  - 对内存友好，可以保证过期键会尽可能快地被删除，并释放过期键所占用地内存
  - 但对CPU时间不友好。影响服务器的响应时间和吞吐量
  - Redis服务器中的时间事件的实现方式是无序链表，查找一个事件的时间复杂度为O(N)，比较低效
- 惰性删除
  - 放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期就删除，没有就返回
  - 对CPU时间最友好，对内存不友好
  - 会造成有些键永远不会被删除，造成内存泄漏
- 定期删除
  - 每隔一段时间就对数据库进行一次检查，删除里面的过期键
  - 前两种策略的折中操作
- Redis的过期键删除策略
  - 配合使用惰性删除和定期删除策略
  - 所有读写数据库的Redis命令在执行之前都会调用expireIfNeeded函数对输入键进行检查，如果输入键已经过期，会将输入键从数据库中删除
  - Redis服务器会周期性地执行serverCron函数，会调用activeExpireCycle函数在规定的时间内，分多次遍历服务器的各个数据库，从数据库的过期字典中随机检查一部分键的过期时间，并删除其中的过期键
  
## AOF,RDB和复制功能对过期键的处理

- 创建一个新的RDB文件时，已过期的键不会被保存到新创建的RDB文件中
- 载入RDB文件时
  - 如果服务器以主服务器模式运行，未过期的键会被载入到数据库中，过期间会被忽略
  - 以从服务器模式运行，所有键，无论是否过期，都会被载入到数据库中
- 当服务器以AOF持久化模式运行时，如果键已过期，但还没有被惰性删除或者定期删除，那么AOF文件不会有任何变动。只有当过期键被惰性删除或者定期删除后，会向AOF文件追加一条DEL命令，显示记录该建已经删除
- 执行AOF重写时，已过期的键不会被保存到重写的AOF文件中
- 当服务器运行在复制模式下时，从服务器的过期键删除动作由主服务器控制
  - 主服务器在删除一个过期键后，会显示地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键
  - 从服务器即使碰到了过期键也不会将其删除，而是继续像处理未过期地键一样来处理过期键
  - 从服务器只有在接到主服务器发来地DEL命令后，才会删除过期键
  - 这种策略可以保证主从服务器数据的一致性

# 数据库通知

- 可以让客户端通过订阅给定的频道或者模式，来获知数据库中键的变化，以及数据库中命令的执行情况
- 键空间通知：关注某个键执行了什么命令
- 键事件通知：关注某个命令被什么键执行了

# 重点回顾

- Redis 服务器的所有数据库都保存在 redisServer.db 数组中， 而数据库的数量则由 redisServer.dbnum 属性保存。
- 客户端通过修改目标数据库指针， 让它指向 redisServer.db 数组中的不同元素来切换不同的数据库。
- 数据库主要由 dict 和 expires 两个字典构成， 其中 dict 字典负责保存键值对， 而 expires 字典则负责保存键的过期时间。
- 因为数据库由字典构成， 所以对数据库的操作都是建立在字典操作之上的。
- 数据库的键总是一个字符串对象， 而值则可以是任意一种 Redis 对象类型， 包括字符串对象、哈希表对象、集合对象、列表对象和有序集合对象， 分别对应字符串键、哈希表键、集合键、列表键和有序集合键。
- expires 字典的键指向数据库中的某个键， 而值则记录了数据库键的过期时间， 过期时间是一个以毫秒为单位的 UNIX 时间戳。
- Redis 使用惰性删除和定期删除两种策略来删除过期的键： 惰性删除策略只在碰到过期键时才进行删除操作， 定期删除策略则每隔一段时间， 主动查找并删除过期键。
- 执行 SAVE 命令或者 BGSAVE 命令所产生的新 RDB 文件不会包含已经过期的键。
- 执行 BGREWRITEAOF 命令所产生的重写 AOF 文件不会包含已经过期的键。
- 当一个过期键被删除之后， 服务器会追加一条 DEL 命令到现有 AOF 文件的末尾， 显式地删除过期键。
- 当主服务器删除一个过期键之后， 它会向所有从服务器发送一条 DEL 命令， 显式地删除过期键。
- 从服务器即使发现过期键， 也不会自作主张地删除它， 而是等待主节点发来 DEL 命令， 这种统一、中心化的过期键删除策略可以保证主从服务器数据的一致性。
- 当 Redis 命令对数据库进行修改之后， 服务器会根据配置， 向客户端发送数据库通知。