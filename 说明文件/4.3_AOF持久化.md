AOF持久化
-----------------------------------------

- [简介](#简介)
- [AOF持久化的实现](#aof持久化的实现)
  - [命令追加](#命令追加)
  - [AOF文件的写入与同步](#aof文件的写入与同步)
- [AOF文件的载入与数据还原](#aof文件的载入与数据还原)
- [AOF重写](#aof重写)
# 简介

- AOF，Append Only File
- RDB持久化通过保存数据库中的键值对来记录数据库状态的不同
- AOF持久化通过保存Redis服务器所执行的写命令来记录数据库状态
- 被写入AOF文件的所有命令都是以Redis的命令请求协议格式保存的，是纯文本格式，可以直接打开一个AOF文件，观察里面的内容
- 服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭时的数据库状态

# AOF持久化的实现

- AOF 持久化功能的实现可以分为命令追加（append）、文件写入、文件同步（sync）三个步骤。

## 命令追加

- 当 AOF 持久化功能处于打开状态时， 服务器在执行完一个写命令之后， 会以协议格式将被执行的写命令追加到服务器状态的 aof_buf 缓冲区的末尾

## AOF文件的写入与同步

- Redis 的服务器进程就是一个事件循环（loop）， 这个循环中的文件事件负责接收客户端的命令请求， 以及向客户端发送命令回复， 而时间事件则负责执行像 serverCron 函数这样需要定时运行的函数。
- 因为服务器在处理文件事件时可能会执行写命令， 使得一些内容被追加到 aof_buf 缓冲区里面， 所以在服务器每次结束一个事件循环之前， 它都会调用 flushAppendOnlyFile 函数， 考虑是否需要将 aof_buf 缓冲区中的内容写入和保存到 AOF 文件里面
- flushAppendOnlyFile 函数的行为由服务器配置的 appendfsync 选项的值来决定， 各个不同值产生的行为如下表所示。如果用户没有主动为 appendfsync 选项设置值， 那么 appendfsync 选项的默认值为 everysec 。
  - 写入是调用write写入内存缓冲区
  - 同步是flush，将缓冲区中的数据写入到硬盘中

appendfsync 选项的值|flushAppendOnlyFile 函数的行为
|-----|-------|
always|将 aof_buf 缓冲区中的所有内容写入并同步到 AOF 文件。
everysec|将 aof_buf 缓冲区中的所有内容写入到 AOF 文件， 如果上次同步 AOF 文件的时间距离现在超过一秒钟， 那么再次对 AOF 文件进行同步， 并且这个同步操作是由一个线程专门负责执行的。
no|将 aof_buf 缓冲区中的所有内容写入到 AOF 文件， 但并不对 AOF 文件进行同步， 何时同步由操作系统来决定。



# AOF文件的载入与数据还原

- 因为AOF文件里面包含了重建数据库状态所需的所有写命令，所以服务器只要读入并重新执行一遍AOF文件里面保存的写命令，就可以还原服务器关闭之前的数据库状态
- 详细步骤如下
  1. 创建一个不带网络连接的伪客户端
  2. 从AOF文件中分析并读取出一条写命令
  3. 使用伪客户端执行被读书的写命令
  4. 重复执行步骤2，3，直到所有写命令都处理完毕

# AOF重写

- 

