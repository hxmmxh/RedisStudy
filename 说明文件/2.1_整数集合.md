# 整数集合

- [整数集合](#整数集合)
  - [简介](#简介)
  - [实现](#实现)
    - [结构体](#结构体)
    - [升级](#升级)
    - [不存在空间预分配和惰性回收](#不存在空间预分配和惰性回收)
  - [API](#api)

## 简介
- 整数集合（intset）是集合键的底层实现之一： 当一个集合只包含整数值元素， 并且这个集合的元素数量不多时， Redis 就会使用整数集合作为集合键的底层实现
- 整数集合（intset）是 Redis 用于保存整数值的集合抽象数据结构， 它可以保存类型为 int16_t 、 int32_t 或者 int64_t 的整数值， 并且保证集合中不会出现重复元素。

## 实现

### 结构体

```c
typedef struct intset 
{
    // 编码方式
    uint32_t encoding;
    // 集合包含的元素数量
    uint32_t length;
    // 保存元素的数组
    int8_t contents[];
} intset;
```
- contents 数组是整数集合的底层实现： 整数集合的每个元素都是 contents 数组的一个数组项（item）， 各个项在数组中按值的大小从小到大有序地排列， 并且数组中不包含任何重复项。
- length 属性记录了整数集合包含的元素数量， 也即是 contents 数组的长度。
- 虽然 intset 结构将 contents 属性声明为 int8_t 类型的数组， 但实际上 contents 数组并不保存任何 int8_t 类型的值 —— contents 数组的真正类型取决于 encoding 属性的值：
  - 如果 encoding 属性的值为 INTSET_ENC_INT16 ， 那么 contents 就是一个 int16_t 类型的数组， 数组里的每个项都是一个 int16_t 类型的整数值 （最小值为 -32,768 ，最大值为 32,767 ）。
  - 如果 encoding 属性的值为 INTSET_ENC_INT32 ， 那么 contents 就是一个 int32_t 类型的数组， 数组里的每个项都是一个 int32_t 类型的整数值 （最小值为 -2,147,483,648 ，最大值为 2,147,483,647 ）。
  - 如果 encoding 属性的值为 INTSET_ENC_INT64 ， 那么 contents 就是一个 int64_t 类型的数组， 数组里的每个项都是一个 int64_t 类型的整数值 （最小值为 -9,223,372,036,854,775,808 ，最大值为 9,223,372,036,854,775,807 ）。

### 升级

- 每当我们要将一个新元素添加到整数集合里面， 并且新元素的类型比整数集合现有所有元素的类型都要长时， 整数集合需要先进行升级（upgrade）， 然后才能将新元素添加到整数集合里面。
- 升级整数集合并添加新元素共分为三步进行
  - 根据新元素的类型， 扩展整数集合底层数组的空间大小， 并为新元素分配空间。
  - 将底层数组现有的所有元素都转换成与新元素相同的类型， 并将类型转换后的元素放置到正确的位上， 而且在放置元素的过程中， 需要继续维持底层数组的有序性质不变。
  - 将新元素添加到底层数组里面。
- 因为引发升级的新元素的长度总是比整数集合现有所有元素的长度都大， 所以这个新元素的值要么就大于所有现有元素， 要么就小于所有现有元素：
  - 在新元素小于所有现有元素的情况下， 新元素会被放置在底层数组的最开头（索引 0 ）；
  - 在新元素大于所有现有元素的情况下， 新元素会被放置在底层数组的最末尾（索引 length-1 ）。
- 好处
  - 提升整数集合的灵活性，可以随意地将 int16_t 、 int32_t 或者 int64_t 类型的整数添加到集合中， 而不必担心出现类型错误， 这种做法非常灵活
  - 尽可能地节约内存,以让集合能同时保存三种不同类型的值， 又可以确保升级操作只会在有需要的时候进行， 这可以尽量节省内存。
- 整数集合不支持降级操作， 一旦对数组进行了升级， 编码就会一直保持升级后的状态

### 不存在空间预分配和惰性回收
- 每添加一个元素扩展一次空间
- 每删除一个元素收缩一次空间
## API

函数|作用|时间复杂度
-|-|-
intsetNew|创建一个新的整数集合。|O(1)
intsetAdd|将给定元素添加到整数集合里面。|O(N)
intsetRemove|从整数集合中移除给定元素。|O(N)
intsetFind|检查给定值是否存在于集合。|因为底层数组有序，查找可以通过二分查找法来进行， 所以复杂度为 O(log N) 。
intsetRandom|从整数集合中随机返回一个元素。|O(1)
intsetGet|取出底层数组在给定索引上的元素。|O(1)
intsetLen|返回整数集合包含的元素个数。|O(1)
intsetBlobLen|返回整数集合占用的内存字节数。|O(1)
